<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Admin â€¢ Confession Wall</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: radial-gradient(circle at top, #0f172a 0%, #020617 55%, #020617 100%);
        --card: rgba(15, 23, 42, 0.35);
        --border: rgba(148, 163, 184, 0.14);
        --text: #e2e8f0;
        --muted: rgba(226, 232, 240, 0.6);
      }
      * { box-sizing: border-box; }
      body {
        margin: 0; background: var(--bg); color: var(--text);
        font-family: system-ui, -apple-system, "Segoe UI", sans-serif; min-height: 100vh;
      }
      header { background: rgba(2,6,23,.45); border-bottom: 1px solid rgba(148,163,184,.12); backdrop-filter: blur(8px); }
      .nav { max-width:1140px; margin:0 auto; padding:.8rem 1.2rem; display:flex; justify-content:space-between; align-items:center; gap:1rem; }
      .logo a { color: var(--text); text-decoration:none; font-weight:700; }
      .links { display:flex; gap:.55rem; flex-wrap:wrap; }
      .links a { color:var(--muted); text-decoration:none; font-size:.7rem; padding:.35rem .7rem; border-radius:9999px; }
      .links a:hover { background: rgba(56,189,248,.12); color:var(--text); }
      main { max-width:1140px; margin:0 auto; padding:1.4rem 1.2rem 2.5rem; }
      .card { background: var(--card); border:1px solid var(--border); border-radius:.8rem; padding:.85rem .9rem .7rem; margin-bottom:.75rem; }
      .small { font-size:.75rem; color:var(--muted); }
      button { background:#22c55e; border:none; padding:.45rem .8rem; border-radius:.5rem; font-weight:600; cursor:pointer; }
      .hidden { display:none; }
      input[type=password]{
        background: rgba(15,23,42,.15); border:1px solid rgba(148,163,184,.4);
        border-radius:.5rem; padding:.45rem .6rem; color:#e2e8f0;
      }
      .topbar { display:flex; gap:1rem; align-items:center; margin-bottom:.8rem; }
    </style>
  </head>
  <body>
    <header>
      <div class="nav">
        <div class="logo"><a href="/">Confession Wall</a></div>
        <div class="links">
          <a href="/">Home</a>
          <a href="/public.html">Public</a>
          <a href="/submit.html">Submit</a>
          <a href="/updates.html">Updates</a>
          <a href="/token.html">Token</a>
        </div>
      </div>
    </header>

    <main>
      <h1 style="margin-bottom:.3rem;">Admin panel</h1>
      <p class="small">Approve incoming confessions. Keep this URL private.</p>

      <!-- TOKEN LOCK -->
      <div id="lock" class="card">
        <p class="small" style="margin-top:.2rem;">Enter admin token:</p>
        <input type="password" id="admintoken" placeholder="Admin token" />
        <button onclick="unlock()">Enter</button>
      </div>

      <!-- PANEL -->
      <div id="panel" class="hidden">
        <div class="topbar">
          <button onclick="loadPending()">Reload</button>
          <p id="status" class="small"></p>
        </div>
        <div id="list"></div>
      </div>
    </main>

    <script>
      // --- Helpers ---
      function escapeHtml(s){
        return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
      }
      function getToken(){
        return (sessionStorage.getItem('ADMIN_TOKEN') || '')
          .replace(/[^\x20-\x7E]/g,'')
          .trim();
      }

      // --- Auth lock ---
      function unlock(){
        let t = document.getElementById('admintoken').value || '';
        t = t.replace(/[^\x20-\x7E]/g,'').trim();  // gizli/ASCII dÄ±ÅŸÄ± karakterleri at
        if(!t){ alert('Token required'); return; }
        sessionStorage.setItem('ADMIN_TOKEN', t);
        document.getElementById('lock').classList.add('hidden');
        document.getElementById('panel').classList.remove('hidden');
        loadPending();
      }

      // SayfayÄ± aÃ§Ä±nca token varsa direkt paneli gÃ¶ster
      document.addEventListener('DOMContentLoaded', ()=>{
        if(getToken()){
          document.getElementById('lock').classList.add('hidden');
          document.getElementById('panel').classList.remove('hidden');
          loadPending();
        }
      });

      // --- Data: pending list ---
      async function loadPending(){
        const list = document.getElementById('list');
        list.innerHTML = 'Loading...';

        const token = getToken();
        if(!token){ list.innerHTML = 'No admin token'; return; }

        const h = new Headers();
        h.set('Authorization','Bearer '+token);

        try{
          const r = await fetch('/api/pending', { headers: h });
          if (r.status === 401){ list.innerHTML = 'Unauthorized (bad token)'; return; }
          if (!r.ok){ list.innerHTML = 'Error loading ('+r.status+')'; return; }

          const { data } = await r.json();
          if (!data || !data.length){
            list.innerHTML = '<p class="small">No pending confessions ðŸŽ‰</p>';
            return;
          }

          list.innerHTML = data.map(row => `
            <div class="card">
              <p>${escapeHtml(row.text)}</p>
              <p class="small">${new Date(row.created_at).toLocaleString()}</p>
              <button onclick="approve('${row.id}')">Approve</button>
            </div>
          `).join('');
        }catch(e){
          list.innerHTML = 'Network error';
        }
      }

      // --- Approve action ---
      async function approve(id){
        const token = getToken();
        if(!token){ alert('No admin token'); return; }

        const h = new Headers();
        h.set('Authorization','Bearer '+token);

        const r = await fetch('/api/approve?id='+encodeURIComponent(id), { headers: h });
        if(!r.ok){ alert('Approve failed'); return; }
        document.getElementById('status').textContent = 'Approved âœ“';
        loadPending();
      }
    </script>
  </body>
</html>
